// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(cuid())
  name                  String?
  email                 String    @unique
  emailVerified         DateTime? @map("email_verified")
  password              String
  twoFactorEnabled      Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret       String?   @map("two_factor_secret")
  role                  Role      @default(USER)
  lastLoginAt           DateTime? @map("last_login_at")
  lastLoginIp           String?   @map("last_login_ip")
  failedLoginAttempts   Int       @default(0) @map("failed_login_attempts")
  accountLocked         Boolean   @default(false) @map("account_locked")
  accountLockedUntil    DateTime? @map("account_locked_until")
  passwordResetToken    String?   @unique @map("password_reset_token")
  passwordResetExpires  DateTime? @map("password_reset_expires")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  sessions              Session[]
  createdTestflightBuilds TestflightBuild[] @relation("CreatedTestflightBuilds")
  updatedTestflightBuilds TestflightBuild[] @relation("UpdatedTestflightBuilds")
  testflightBuildLogs   TestflightBuildLog[]
  createdDiscordCommands DiscordCommand[] @relation("CreatedDiscordCommands")
  updatedDiscordCommands DiscordCommand[] @relation("UpdatedDiscordCommands")

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique @map("refresh_token")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("sessions")
}

model TestflightBuild {
  id              String               @id @default(cuid())
  name            String
  version         String
  buildNumber     String               @map("build_number")
  testflightUrl   String               @map("testflight_url")
  status          TestflightStatus     @default(PENDING)
  lastCheckedAt   DateTime?            @map("last_checked_at")
  expiresAt       DateTime?            @map("expires_at")
  notes           String?              @db.Text
  isPublic        Boolean              @default(false) @map("is_public")
  createdById     String               @map("created_by")
  createdBy       User                 @relation("CreatedTestflightBuilds", fields: [createdById], references: [id])
  updatedById     String?              @map("updated_by")
  updatedBy       User?                @relation("UpdatedTestflightBuilds", fields: [updatedById], references: [id])
  logs            TestflightBuildLog[]
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  @@unique([version, buildNumber])
  @@map("testflight_builds")
}

model TestflightBuildLog {
  id                String          @id @default(cuid())
  buildId           String          @map("build_id")
  build             TestflightBuild @relation(fields: [buildId], references: [id], onDelete: Cascade)
  status            TestflightStatus
  message           String?         @db.Text
  checkedByUserId   String?         @map("checked_by_user_id")
  checkedBy         User?           @relation(fields: [checkedByUserId], references: [id])
  checkedAt         DateTime        @default(now()) @map("checked_at")
  responseTimeMs    Int?            @map("response_time_ms")
  httpStatus        Int?            @map("http_status")
  errorDetails      String?         @db.Text @map("error_details")

  @@map("testflight_build_logs")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum TestflightStatus {
  PENDING
  ACTIVE
  EXPIRED
  NOT_FOUND
  ERROR
}

model DiscordCommand {
  id                String                @id @default(cuid())
  name              String                @unique
  description       String
  category          String?
  enabled           Boolean               @default(true)
  permissions       String[]              // Array of required permissions
  cooldown          Int                   @default(0) // Cooldown in seconds
  guildOnly         Boolean               @default(false)
  ownerOnly         Boolean               @default(false)
  nsfw              Boolean               @default(false)
  aliases           String[]              // Command aliases
  usage             String?               // Usage example
  examples          String[]              // Usage examples
  options           DiscordCommandOption[]
  responses         DiscordCommandResponse[]
  createdById       String                @map("created_by")
  createdBy         User                  @relation("CreatedDiscordCommands", fields: [createdById], references: [id])
  updatedById       String?               @map("updated_by")
  updatedBy         User?                 @relation("UpdatedDiscordCommands", fields: [updatedById], references: [id])
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  @@map("discord_commands")
}

model DiscordCommandOption {
  id          String                    @id @default(cuid())
  commandId   String                    @map("command_id")
  command     DiscordCommand            @relation(fields: [commandId], references: [id], onDelete: Cascade)
  name        String
  description String
  type        DiscordCommandOptionType
  required    Boolean                   @default(false)
  choices     DiscordCommandChoice[]
  minValue    Float?                    @map("min_value")
  maxValue    Float?                    @map("max_value")
  minLength   Int?                      @map("min_length")
  maxLength   Int?                      @map("max_length")
  autocomplete Boolean                  @default(false)
  channelTypes String[]                 @map("channel_types") // For channel options
  order       Int                       @default(0)

  @@map("discord_command_options")
}

model DiscordCommandChoice {
  id       String               @id @default(cuid())
  optionId String               @map("option_id")
  option   DiscordCommandOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  name     String
  value    String
  order    Int                  @default(0)

  @@map("discord_command_choices")
}

model DiscordCommandResponse {
  id          String         @id @default(cuid())
  commandId   String         @map("command_id")
  command     DiscordCommand @relation(fields: [commandId], references: [id], onDelete: Cascade)
  trigger     String         // What triggers this response (subcommand, option value, etc.)
  content     String?        @db.Text
  embeds      Json?          // JSON array of embed objects
  components  Json?          // JSON array of component objects (buttons, select menus)
  files       String[]       // Array of file URLs/paths
  ephemeral   Boolean        @default(false)
  deleteAfter Int?           @map("delete_after") // Auto-delete after X seconds
  reactions   String[]       // Array of emoji reactions to add
  order       Int            @default(0)

  @@map("discord_command_responses")
}

enum DiscordCommandOptionType {
  SUB_COMMAND
  SUB_COMMAND_GROUP
  STRING
  INTEGER
  BOOLEAN
  USER
  CHANNEL
  ROLE
  MENTIONABLE
  NUMBER
  ATTACHMENT
}
